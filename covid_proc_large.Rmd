---
title: "Covid_procurements"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(stringr)
library(ggstatsplot)
library(splusTimeDate)
```

## Merge & clean Files

The files results_all_records_x were scrapped from the Mission Mode Portal over two weeks. 
These files contain "Sno", "e_published date", "Award of contract date" "Title and Description" and "State". We will first merge the four files that were scrapped and clean them

```{r Merge, echo=FALSE}
## read the csvs as a tibble for easier tidyverse stuff (especially string replace which requires it)
results_1 <- as.tibble(read.csv("results_all_records_table.csv", row.names = NULL,
                                stringsAsFactors = FALSE))
results_1a <- as.tibble(read.csv("results_all_records_table_1.csv", row.names =NULL,
                                stringsAsFactors = FALSE))

results_2 <- as.tibble(read.csv("results_all_records_table_2.csv", row.names = NULL, 
                                stringsAsFactors = FALSE))
results_3 <- as.tibble(read.csv("results_all_records_table_3.csv",row.names = NULL, 
                                stringsAsFactors = FALSE))
results_4 <- as.tibble(read.csv("results_all_records_table_4.csv",row.names = NULL, 
                                stringsAsFactors = FALSE))
results_extra <- as.tibble(read.csv("results_all_records_table_extra.csv", 
                           row.names = NULL, stringsAsFactors = FALSE))

## merge the four files with rbind
results_total_merge<- rbind(results_1,results_1a,results_2,results_3,results_4, results_extra)

## clean the merged file of the b' that .' that is added as a part of the python scrapper

results_total_merge_clean<- results_total_merge %>%
    mutate_all(funs(str_replace(., "b'", "")))

results_total_merge_clean <- results_total_merge_clean %>% 
  mutate_all(funs(str_replace(., "'", "")))

results_total_merge_clean <- results_total_merge_clean %>% 
  mutate_all(funs(str_replace(., "\\.", "")))

## rename the columns
results_total_merge_clean <- results_total_merge_clean %>% 
  rename(
    Sno= row.names,
    award_date = S.No.,
    Published_date = AOC.Date,
    Title_description = e.Published.Date, 
    State_name = Title.and.Ref.No..Tender.Id, 
    Tender_ID = State.Name
    )

## Make dates into date format
results_total_merge_clean$award_date <- as.Date(results_total_merge_clean$award_date, 
                                                format="%d-%b-%Y")

results_total_merge_clean$Published_date <- as.Date(results_total_merge_clean$Published_date, 
                                                    format="%d-%b-%Y")

##remove duplicates
results_no_duplicates <- results_total_merge_clean [!duplicated(results_total_merge_clean[c(4,6)]),]
```

## Initial look

We can have an initial look at the data that we have cleaned so far. For example we can see which states have the most number of tenders and what the different durations for the tendering process are

```{r initial, echo=FALSE}
## this will produce the top ten states that have most number of procurements on mmp

tender_number <- results_no_duplicates %>% group_by(State_name) %>% tally()
head(tender_number[order(tender_number$n, decreasing = TRUE),])

## Here we are creating a simple bar plot with counts for each state
results_no_duplicates %>% ggplot(aes(x = State_name))+ 
  geom_bar ()+
  theme(axis.text.x = element_text(size = 6, angle = 90))

#Here we have calculated the number of days between the published and awarded date
results_no_duplicates$number_days<-
  as.numeric(difftime (results_no_duplicates$award_date, 
                       results_no_duplicates$Published_date,units = c("days")))

## we are now trying to create a stacked box plot to see the difference in days taken
results_no_duplicates %>% ggplot(aes(x = State_name, fill = number_days))+ 
  geom_bar ()+
  theme(axis.text.x = element_text(size = 6, angle = 90))

## Since the variation in the other plot is so big, lets make a box plot and see how it looks

results_no_duplicates %>% ggplot(aes(x=State_name, y=number_days)) + 
  geom_boxplot() + theme(axis.text.x = element_text(size = 6, angle = 90))

## There seems to be quite a bit of variation, so i will be identifying the outliers to eliminate
Q <- quantile(results_no_duplicates$number_days, probs=c(.5, .9), na.rm = FALSE)

iqr <- IQR(results_no_duplicates$number_days)

up <-  Q[2]+1.5*iqr
down <- Q[1] - 1.5*iqr

not_eliminated<- subset(results_no_duplicates, 
                        results_no_duplicates$number_days > (Q[1] - 1.5*iqr) 
                        & results_no_duplicates$number_days < (Q[2]+1.5*iqr))

## I will then plot the new dataset to see how it has changed
##outliers <- ggbetweenstats(data = results_no_duplicates, x = State_name, y=number_days, outlier.tagging = TRUE, na.rm = TRUE) 

## I am seeing whats there in the eliminated (outliers)
eliminated <- subset(results_no_duplicates, 
                     !(results_no_duplicates$number_days > 
                         (Q[1] - 1.5*iqr) & results_no_duplicates$number_days < 
                         (Q[2]+1.5*iqr)))

eliminated %>% ggplot(aes(x=State_name, y=number_days)) + geom_boxplot() + 
  theme(axis.text.x = element_text(size = 6, angle = 90))

##I have decided to use the non-outliered dataset since, the data in the eliminated set seems important

## I am creating bins for the length of the different procurement periods according to state

results_no_duplicates$day_category <- cut(results_no_duplicates$number_days, 
                                          breaks = c(0, 30, 60, Inf))

## I am plotting this data using a stacked bar graph

results_no_duplicates %>% ggplot(aes(x=State_name, fill = day_category)) + 
  geom_bar() +theme(axis.text.x = element_text(size = 6, angle = 90))

```

## Next I will create smaller datasets for specific usecases. The following is a table for words related to health and covid. Isolating all procurements associated with the keywords will give us a subset of health and covid related procurements. (Note: while health is a general enough term, I have taken caution not to include sanitation under this. Health in this case will only comprise of acute/chronic hospital related procurements not general sanitation or food/nutrition)

```{r pattern, echo=FALSE}
patterns <-data.frame(word = c("Medical", "Hospital", "PHC", "CHC", "Health", "covid", "COVID", "medicine", "drugs", "liquid", "ambulance",  "microscope", "chemistry", "radiograph", "biomedical", "laboratory", "dispensary", "Anganwadi","DHS","subcentre", "ANM", "sub centre", "HWC", "RBSK", "JSSK", "KASP","crematorium","DNASTAR","mortem","paediatric","MCH","Smashanbhumi","Shmashanbhumi","smashan bhumi","OPD","HFW","ICDS","RT-PCR", "corona","anganwari","NHM","Advia","Oxygen","HCG","AWC","DGPCS"))

#pattern_match <- data.frame(word = c("Medical","Hospital","PHC","CHC","Health","covid","medicine","drugs","liquid", "ambulance","microscope","chemistry", "radiograph","biomedical","lab","laboratory","dispensary","Anganwadi","DHS","subcentre", "ANM", "sub centre", "HWC", "RBSK", "JSSK", "KASP", "crematorium", "DNASTAR","mortem", "paediatric", "HWC", "MCH", "Smashanbhumi", "Shmashanbhumi", "smashan bhumi", "OPD", "HFW", "ICDS","RT-PCR","corona","anganwari","NHM", "TCL","Advia","Oxygen","HCG","AWC","DGPCS"), matching = c("1l", "2", "3", "4","5", "6", "7", "8", "9", "10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","21","32","33","34","35","36", "37", "38","39","40","41", "42", "43", "44", "45", "46", "47", "48"))

  
newtable <- results_no_duplicates %>% 
  filter_all(any_vars(str_detect(.,paste(patterns$word, collapse = "|"))))

newtable %>% 
  filter(!grepl('Veterinary', Title_description))

#supply, construction,maintanence, repair, up-gradation, upgradation, Improvement, Installation, Labour, facility, printing, work, outsource, manpower, const, Reconstruction, handling, service, providing, purchase, strenghthening, painting, road?,replacing, training,transport, Running, nirman, establishment, renovation, 

## Different ways to add keywords. The non-commented out one works best (need to figure out how to add more than 1 key word)
#newtable <- newtable%>% 
#mutate(newcol = str_replace(Title_description, pattern_match$word, pattern_match$matching, vectorize_all = FALSE))

#for(i in seq_len(nrow(pattern_match))) {
 #want <- grepl(pattern_match[i, "word"], newtable[,"Title_description"],ignore.case = T)
 #newtable[want, "matching"] <- pattern_match[i, "matching"]
#} 
#results_no_duplicates$newcol <- results_no_duplicates %>% 
#paste(any_vars(str_detect(.,paste(patterns$word, collapse = "|"))))

newtable$keywords <- str_extract(newtable$Title_description, str_flatten(patterns$word, "|"))

toMatch<-c("^health","^hospital", "^PHC", "^CHC", "^Hospital", "^subcentre", "^HWC")
newtable$keywords<-as.character(newtable$keywords)
newtable[grepl(paste(toMatch,collapse="|"),newtable$keywords ),"keywords"]<-"Hospital"

toMatch<-c("^ANM","^anganwari", "^Anganwadi","^AWC", "^paediatric")
newtable$keywords<-as.character(newtable$keywords)
newtable[grepl(paste(toMatch,collapse="|"),newtable$keywords ),"keywords"]<-"Paediatric"

toMatch<-c("^ICDS","^JSSK", "^ICDS","^RBSK", "^NHM", "^KASP", "^DGPCS", "^DHS")
newtable$keywords<-as.character(newtable$keywords)
newtable[grepl(paste(toMatch,collapse="|"),newtable$keywords ),"keywords"]<-"Schemes"


toMatch<-c("^covid","^COVID", "^corona","^cylinder", "^oxygen", "^DNASTAR", "^RT-PCR", "^liquid", "^drugs", "^crematorium", "^Smashanbhumi", "^Shmashanbhumi","^smashan bhumi","^OPD", "^Advia")
newtable$keywords<-as.character(newtable$keywords)
newtable[grepl(paste(toMatch,collapse="|"),newtable$keywords ),"keywords"]<-"COVID"

Q <- quantile(newtable$number_days, probs=c(.5, .9), na.rm = FALSE)

iqr <- IQR(newtable$number_days)

up <-  Q[2]+1.5*iqr
down <- Q[1] - 1.5*iqr

newtable<- subset(newtable, 
           newtable$number_days > (Q[1] - 1.5*iqr) 
           & newtable$number_days < (Q[2]+1.5*iqr))

state_tenders<- newtable %>% group_by(State_name) %>% tally()
head(state_tenders[order(state_tenders$n, decreasing = TRUE),])

newtable %>% ggplot(aes(x = State_name))+ 
  geom_bar ()+
  theme(axis.text.x = element_text(size = 6, angle = 90))

newtable %>% ggplot(aes(x=State_name, y=number_days)) + 
  geom_boxplot() + theme(axis.text.x = element_text(size = 6, angle = 90))

newtable %>% ggplot(aes(x=State_name, fill = day_category)) + 
  geom_bar() +theme(axis.text.x = element_text(size = 6, angle = 90))


newtable$Month <- format(as.Date(newtable$Published_date, "%Y/%m/%d"), "%m")

newtable %>% ggplot(aes(x=Month, fill = day_category)) + 
  geom_bar() +theme(axis.text.x = element_text(size = 6, angle = 90))

```

